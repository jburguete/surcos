/*
SURCOS - A software tool to solve irrigation and fertigation in isolated furrows
and furrow networks.

Copyright 2011-2025, Javier Burguete Tolosa.

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY Javier Burguete Tolosa ``AS IS'' AND ANY EXPRESS OR
IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL Javier Burguete Tolosa OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

/**
 * \file configFurrows.c
 * \brief Source file to define the configuration of the furrows data.
 * \authors Javier Burguete Tolosa, Asier Lacasta Soto.
 * \copyright Copyright 2011-2025, Javier Burguete Tolosa.
 */
#include "config.h"
#include "jb/src/win.h"
#include "jb/src/json.h"
#include "furrow.h"
#include "configFurrows.h"

///> Diagram of furrows set pixmap.
const char *diagram_furrow[] = {
/* columns rows colors chars-per-pixel */
  "479 160 2 1 ",
  "  c black",
  ". c white",
/* pixels */
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...................................................................................................................................................................................................................   ..   ...  ...............................................................................................................................................................................................................................................................",
  ".................................................................................................................................................................................................................... .... .... ................................................................................................................................................................................................................................................................",
  ".................................................................................................................................................................................................................... ...  .... ................................................................................................................................................................................................................................................................",
  ".................................................................................................................................................................................................................... ...  ... .................................................................................................................................................................................................................................................................",
  "................................................................................................... ................................................................................................................ .. . .. .................................................................................................................. ...............................................................................................................................................",
  ".................................................................................................................................................................................................................... . .. .. ..................................................................................................................................................................................................................................................................",
  "................................................................................................... ................................................................................................................ . .. . ................................................................................................................... ...............................................................................................................................................",
  "....................................................................................................................................................................................................................  ...  ....................................................................................................................................................................................................................................................................",
  "................................................................................................... ................................................................................................................ .... ..................................................................................................................... ...............................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "................................................................................................... ........................................................................................................................................................................................................................................... ...............................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "................................................................................................... ....  ...............................................................................................................................................................................................................................  .... ...............................................................................................................................................",
  ".....................................................................................................    .................................................................................................................................................................................................................................    .................................................................................................................................................",
  "...................................................................................................                                                                                                                                                                                                                                             ...............................................................................................................................................",
  ".....................................................................................................    .................................................................................................................................................................................................................................    .................................................................................................................................................",
  "................................................................................................... ....  ...............................................................................................................................................................................................................................  .... ...............................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "................................................................................................... ........................................................................................................................................................................................................................................... ...............................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "................................................................................................... ........................................................................................................................................................................................................................................... ...............................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "................................................................................................... ........................................................................................................................................................................................................................................... ...............................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "..............................................................................                                           .................................................................................................................................................................................................                                           ..........................................................................................................................",
  ".............................................................................   .......................................   ...............................................................................................................................................................................................   ................... ...................   .........................................................................................................................",
  "............................................................................   .........................................   .............................................................................................................................................................................................   ...................   ...................   ........................................................................................................................",
  "...........................................................................   ...........................................   ...........................................................................................................................................................................................   ....................   ....................   .......................................................................................................................",
  "..........................................................................   .............................................   .........................................................................................................................................................................................   .....................    ....................   ......................................................................................................................",
  ".........................................................................   ...............................................   .......................................................................................................................................................................................   .....................     .....................   .....................................................................................................................",
  "........................................................................   .................................................   .............................       .................................................................................................................................................   ...................... . . ......................   ....................................................................................................................",
  ".......................................................................   ...................................................   ............................ .... .................................................................................................................................................   ......................... .........................   ...................................................................................................................",
  "......................................................................   .....................................................   .......................... .... .................................................................................................................................................   .......................... ..........................   ..................................................................................................................",
  ".....................................................................   .......................................................   ............................. .................................................................................................................................................   ........................... ...........................   .................................................................................................................",
  "....................................................................   .........................................................   ........................... .................................................................................................................................................   ............................ ............................   ................................................................................................................",
  "...................................................................   ...........................................................   ......................... ... .............................................................................................................................................   ............................. .............................   ...............................................................................................................",
  "..................................................................   .............................................................   ....................... .... ............................................................................................................................................   .............................. ..............................   ..............................................................................................................",
  ".................................................................   ...............................................................   ..................... .... ............................................................................................................................................   ............................... ...............................   .............................................................................................................",
  "................................................................   .................................................................   ...................       ...........................................................................................................................................   ................................ ................................   ............................................................................................................",
  "...............................................................   ...................................................................   ...................................................................................................................................................................   ................................. .................................   ...........................................................................................................",
  "..............................................................   .....................................................................   .................................................................................................................................................................   .................................. ..................................   ..........................................................................................................",
  ".............................................................   .......................................................................   ...............................................................................................................................................................   ................................... ...................................   .........................................................................................................",
  "............................................................   .........................................................................   .............................................................................................................................................................   .................................... ....................................   ........................................................................................................",
  "...........................................................   ...........................................................................    . . . . . . . . . . . . . . . . . . . ....................................................................................................................   ..................................... .....................................   .......................................................................................................",
  "..........................................................   .............................................................................   .........................................................................................................................................................   ...................................... ......................................   ......................................................................................................",
  ".........................................................   ...............................................................................   .................................... ..................................................................................................................   ....................................... .......................................   .....................................................................................................",
  "........................................................   .................................................................................   .....................................................................................................................................................   ........................................ ........................................   ....................................................................................................",
  ".......................................................   ...................................................................................   .................................. ................................................................................................................   ......................................... .........................................   ...................................................................................................",
  "......................................................   .....................................................................................   .................................................................................................................................................   .......................................... ..........................................   ..................................................................................................",
  ".....................................................   .......................................................................................   ................................ ..............................................................................................................   ........................................... ...........................................   .................................................................................................",
  "....................................................   .........................................................................................   .............................................................................................................................................   ............................................ ............................................   ................................................................................................",
  "...................................................   ...........................................................................................   .............................. ............................................................................................................   ............................................. .............................................   ...............................................................................................",
  "..................................................   .............................................................................................   .........................................................................................................................................   .............................................. ..............................................   ..............................................................................................",
  ".................................................   ...............................................................................................   ............................ ..........................................................................................................   ............................................... ...............................................   .............................................................................................",
  "................................................   .................................................................................................   .....................................................................................................................................   ................................................ ................................................   ............................................................................................",
  "...............................................   ...................................................................................................   .......................... ........................................................................................................   ................................................. .................................................   ...........................................................................................",
  "..............................................   .....................................................................................................   .................................................................................................................................   .................................................. ..................................................   ..........................................................................................",
  ".............................................   .......................................................................................................   ........................ ......................................................................................................   ................................................... ...................................................   .........................................................................................",
  "............................................   .........................................................................................................   .............................................................................................................................   .................................................... ....................................................   ........................................................................................",
  "...........................................   ...........................................................................................................   ...................... .......   ..........................................................................................   ..................................................... .....................................................   .......................................................................................",
  "..........................................   .............................................................................................................   ............................... .........................................................................................   ...................................................... ......    .    .......................................   ......................................................................................",
  ".........................................   ...............................................................................................................   .................... ......... ........................................................................................   ....................................................... ....... ....  .........................................   .....................................................................................",
  "........................................   .................................................................................................................   ............................. .......................................................................................   ........................................................ ....... .... ...........................................   ....................................................................................",
  ".......................................   ...................................................................................................................   .................. ......... ......................................................................................   ......................................................... ......  .... ............................................   ...................................................................................",
  "......................................   .....................................................................................................................   ........................... .....................................................................................   .......................................................... ......       .............................................   ..................................................................................",
  ".....................................   .......................................................................................................................   ................ ......... ....................................................................................   ........................................................... ...... .... ...............................................   .................................................................................",
  "....................................   .........................................................................................................................   ......................... ...................................................................................   ............................................................ .....  .... ................................................   ................................................................................",
  "...................................   ...........................................................................................................................   .............. .......     ................................................................................   ............................................................. ..... ..... .................................................   ...............................................................................",
  "..................................   .............................................................................................................................   .........................................................................................................   .............................................................. ....    .    .................................................   ..............................................................................",
  ".................................   ...............................................................................................................................   ............ ..........................................................................................   ............................................................... ...............................................................   .............................................................................",
  "................................   .................................................................................................................................   .....................................................................................................   ................................................................ ................................................................   ............................................................................",
  "...............................   ...................................................................................................................................   .......... ........................................................................................   ................................................................. .................................................................   ...........................................................................",
  "..............................   .....................................................................................................................................   .................................................................................................   .................................................................. ..................................................................   ..........................................................................",
  ".............................   .......................................................................................................................................   ........ ......................................................................................   ................................................................... ...................................................................   .........................................................................",
  "............................   .........................................................................................................................................   .............................................................................................   .................................................................... ....................................................................   ........................................................................",
  "...........................   ...........................................................................................................................................   ...... ....................................................................................   ..................................................................... .....................................................................   .......................................................................",
  "..........................   .............................................................................................................................................   .........................................................................................   ...................................................................... ......................................................................   ......................................................................",
  ".........................   ...............................................................................................................................................   .... ..................................................................................   ....................................................................... .......................................................................   .....................................................................",
  "........................   .................................................................................................................................................   .....................................................................................   ........................................................................ ........................................................................   ....................................................................",
  ".......................   ...................................................................................................................................................   .. ................................................................................   ......................................................................... .........................................................................   ...................................................................",
  "......................   .....................................................................................................................................................   .................................................................................   .......................................................................... ..........................................................................   ..................................................................",
  ".....................   .......................................................................................................................................................    ..............................................................................   ........................................................................... ...........................................................................   .................................................................",
  "....................   .........................................................................................................................................................   .............................................................................   ............................................................................ ............................................................................   ................................................................",
  "...................   ...........................................................................................................................................................   ...........................................................................   ............................................................................. .............................................................................   ...............................................................",
  "..................   .............................................................................................................................................................   .........................................................................   .............................................................................. ..............................................................................   ..............................................................",
  ".................   ...............................................................................................................................................................   .......................................................................   ............................................................................... ...............................................................................   .............................................................",
  "................   .................................................................................................................................................................   .....................................................................   ................................................................................ ................................................................................   ............................................................",
  "...............   ...................................................................................................................................................................   ...................................................................   ................................................................................. .................................................................................   ...........................................................",
  "..............   .....................................................................................................................................................................   .................................................................   .................................................................................. ..................................................................................   ..........................................................",
  ".............   .......................................................................................................................................................................   ...............................................................   ................................................................................... ...................................................................................   .........................................................",
  "............   .........................................................................................................................................................................   .............................................................   .................................................................................... ....................................................................................   ........................................................",
  "...........   ...........................................................................................................................................................................   ...........................................................   ..................................................................................... .....................................................................................   .......................................................",
  "..........   .............................................................................................................................................................................   .........................................................   ...................................................................................... ......................................................................................   ......................................................",
  ".........   ...............................................................................................................................................................................   .......................................................   ....................................................................................... .......................................................................................   .....................................................",
  "........   .................................................................................................................................................................................   .....................................................   ........................................................................................ ........................................................................................   ....................................................",
  ".......   ...................................................................................................................................................................................   ...................................................   ......................................................................................... .........................................................................................   ...................................................",
  "......   .....................................................................................................................................................................................   .................................................   .......................................................................................... ..........................................................................................   ..................................................",
  ".....   .......................................................................................................................................................................................   ...............................................   ......................................................................................... . . .........................................................................................   .................................................",
  "....   .........................................................................................................................................................................................   .............................................   ...........................................................................................    ..........................................................................................   ................................................",
  "...   ...........................................................................................................................................................................................   ...........................................   ............................................................................................   ............................................................................................   ...............................................",
  "..   .............................................................................................................................................................................................   .........................................   .............................................................................................   .............................................................................................   ..............................................",
  ".   ...............................................................................................................................................................................................   .......................................   ...............................................................................................  ..............................................................................................   .............................................",
  "   .................................................................................................................................................................................................   .....................................   ...................................................................................... . . . . . . . . . . ......................................................................................   ............................................",
  ". ...................................................................................................................................................................................................                                         ...................................................................................................................................................................................................                                         .....",
  "..................................................................................................................................................................................................... ....................................... .................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... ....................................... .................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... ....................................... .................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... ....................................... .................................................................................................................................................................................................................................................",
  ".........................................................................................................................................................................................................   ...........................   .....................................................................................................................................................................................................................................................",
  ".....................................................................................................................................................................................................                                         .................................................................................................................................................................................................................................................",
  "......................................................................................................................................................................................................     .............................     ..................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... ...   ...........................   ... .................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... ....................................... .................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... ....................................... .................................................................................................................................................................................................................................................",
  ".......................................................................................................................................................................................................................       .................................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... .................. .... ............... .................................................................................................................................................................................................................................................",
  "........................................................................................................................................................................................................................ .... .................................................................................................................................................................................................................................................................",
  "..................................................................................................................................................................................................... ................. .... ................ .................................................................................................................................................................................................................................................",
  ".......................................................................................................................................................................................................................      ..................................................................................................................................................................................................................................................................",
  "....................................................................................................................................................................................................................... ..... .................................................................................................................................................................................................................................................................",
  "....................................................................................................................................................................................................................... ..... .................................................................................................................................................................................................................................................................",
  "...................................................................................................................................................................................................................... ..... ..................................................................................................................................................................................................................................................................",
  ".....................................................................................................................................................................................................................       ...................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................",
  "..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................."
};

/**
 * Function to set configurable a furrow.
 */
static void
config_furrow_set_sensitive (ConfigFurrow * w,
///< Furrow configuration structure.
                             int sensitive)
///< 1 on configurable, 0 on no configurable.
{
  unsigned int i;
  gtk_widget_set_sensitive (GTK_WIDGET (w->button), sensitive);
  for (i = 0; i < 13; ++i)
    gtk_widget_set_sensitive (GTK_WIDGET (w->spin[i]), sensitive);
}

/**
 * Function to set configurable the initial conditions of a furrow.
 */
static void
config_furrow_show_initial_conditions (ConfigFurrow * w,
///< Furrow configuration structure.
                                       int show)
///< 1 on configurable, 0 on no configurable.
{
  unsigned int i;
  for (i = 10; i < 13; ++i)
    if (show)
      gtk_widget_show (GTK_WIDGET (w->spin[i]));
    else
      gtk_widget_hide (GTK_WIDGET (w->spin[i]));
}

/**
 * Function to read a furrow configuration.
 */
static void
config_furrow_read (ConfigFurrow * w)   ///< Furrow configuration structure.
{
  Furrow *f;
  InitialConditions *ic;
  f = w->furrow;
  gtk_spin_button_set_value (w->spin[0], f->b);
  gtk_spin_button_set_value (w->spin[1], f->z);
  gtk_spin_button_set_value (w->spin[2], f->h);
  gtk_spin_button_set_value (w->spin[3], f->D);
  gtk_spin_button_set_value (w->spin[4], f->H);
  gtk_spin_button_set_value (w->spin[5], f->epsilon);
  gtk_spin_button_set_value (w->spin[6], f->n);
  gtk_spin_button_set_value (w->spin[7], f->i1);
  gtk_spin_button_set_value (w->spin[8], f->i2);
  gtk_spin_button_set_value (w->spin[9], f->i3);
  ic = w->initial_conditions;
  gtk_spin_button_set_value (w->spin[10], ic->h);
  gtk_spin_button_set_value (w->spin[11], ic->q);
  gtk_spin_button_set_value (w->spin[12], ic->c);
}

/**
 * Function to write a furrow configuration.
 */
static void
config_furrow_write (ConfigFurrow * w)  ///< Furrow configuration structure.
{
  Furrow *f;
  InitialConditions *ic;
  f = w->furrow;
  f->b = gtk_spin_button_get_value (w->spin[0]);
  f->z = gtk_spin_button_get_value (w->spin[1]);
  f->h = gtk_spin_button_get_value (w->spin[2]);
  f->D = gtk_spin_button_get_value (w->spin[3]);
  f->H = gtk_spin_button_get_value (w->spin[4]);
  f->epsilon = gtk_spin_button_get_value (w->spin[5]);
  f->n = gtk_spin_button_get_value (w->spin[6]);
  f->i1 = gtk_spin_button_get_value (w->spin[7]);
  f->i2 = gtk_spin_button_get_value (w->spin[8]);
  f->i3 = gtk_spin_button_get_value (w->spin[9]);
  ic = w->initial_conditions;
  ic->h = gtk_spin_button_get_value (w->spin[10]);
  ic->q = gtk_spin_button_get_value (w->spin[11]);
  ic->c = gtk_spin_button_get_value (w->spin[12]);
}

/**
 * Function to open a furrow configuration.
 */
static void
config_furrow_new (ConfigFurrow * w,    ///< Furrow configuration structure.
                   const char *label)   ///< Furrow label.
{
  const double min[13] =
    { 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., -1., 0. };
  const double max[13] =
    { 100., 100., 10., 100., 10., 1., 1., 1e6, 1., 1., 10., 1., 1000. };
  const double step[13] = { 0.01, 0.01, 0.01, 0.01, 0.001, 0.001, 0.001, 1e-5,
    0.01, 1e-7, 0.01, 1e-6, 1e-6
  };
  unsigned int i;

  w->button = (GtkButton *) gtk_button_new_with_label (label);
  gtk_widget_set_can_focus (GTK_WIDGET (w->button), FALSE);
  for (i = 0; i < 13; ++i)
    w->spin[i] = (GtkSpinButton *) gtk_spin_button_new_with_range
      (min[i], max[i], step[i]);
}

/**
 * Function to update a field furrows configuration.
 */
void
table_config_furrows_update (TableConfigFurrows * w)
///< Field furrows configuration structure.
{
  ConfigFurrow *f;
  unsigned int i, n;
  f = w->furrow;
  n = gtk_spin_button_get_value_as_int (w->spin);
  // Sensitive if they are recirculation furrow
  i = gtk_check_button_get_active (w->button_recirculation);
  config_furrow_set_sensitive (f + 2, i);
  // Sensitive if they are irrigation furrows
  config_furrow_set_sensitive (f + 1, (n > 0) ? 1 : 0);
  // Sensitive if they are initial conditions
  n = gtk_check_button_get_active (w->check_button_initial_conditions);
  for (i = 0; i < 3; ++i)
    config_furrow_show_initial_conditions (f + i, n);
  if (n)
    {
      gtk_widget_show (GTK_WIDGET (w->button_initial_conditions));
      for (i = 10; i < 13; ++i)
        gtk_widget_show (GTK_WIDGET (w->button_coefficient[i]));
    }
  else
    {
      gtk_widget_hide (GTK_WIDGET (w->button_initial_conditions));
      for (i = 10; i < 13; ++i)
        gtk_widget_hide (GTK_WIDGET (w->button_coefficient[i]));
    }
}

/**
 * Function to read a field furrows configuration.
 */
void
table_config_furrows_read (TableConfigFurrows * w)
///< Field furrows configuration structure.
{
  ConfigFurrow *cf;
  cf = w->furrow;
  gtk_spin_button_set_value (w->spin, w->nfurrows);
  gtk_check_button_set_active (w->button_recirculation, w->recirculation);
  gtk_check_button_set_active (w->check_button_initial_conditions,
                               w->initial_conditions);
  config_furrow_read (cf);
  if (w->nfurrows)
    {
      ++cf;
      config_furrow_read (cf);
      if (w->recirculation)
        {
          ++cf;
          config_furrow_read (cf);
        }
    }
}

/**
 * Function to write a field furrows configuration.
 */
void
table_config_furrows_write (TableConfigFurrows * w)
///< Field furrows configuration structure.
{
  ConfigFurrow *cf;
  cf = w->furrow;
  w->nfurrows = gtk_spin_button_get_value_as_int (w->spin);
  w->recirculation = gtk_check_button_get_active (w->button_recirculation);
  w->initial_conditions
    = gtk_check_button_get_active (w->check_button_initial_conditions);
  config_furrow_write (cf);
  if (w->nfurrows)
    {
      ++cf;
      config_furrow_write (cf);
      if (w->recirculation)
        {
          ++cf;
          config_furrow_write (cf);
        }
    }
}

/**
 * Function to open a field furrows configuration.
 */
void
table_config_furrows_new (TableConfigFurrows * w)
///< Field furrows configuration structure.
{
  const char *label_channel[3] = {
    _("Distribution"),
    _("Irrigation"),
    _("Recirculation")
  };
  const char *label_coefficient[13] = {
    "B (m)",
    "Z",
    "H (m)",
    "W (m)",
    "R (m)",
    "e",
    "n",
    "K (m/s^a)",
    "a",
    "f0 (m/s)",
    "h (m)",
    "Q (m^3/s)",
    "c (Kg/m^3)",
  };
  GdkPixbuf *pixbuf;
  unsigned int i, j;
  for (i = 0; i < 3; ++i)
    config_furrow_new (w->furrow + i, label_channel[i]);
  w->grid = (GtkGrid *) gtk_grid_new ();
  w->box_picture = (GtkGrid *) gtk_grid_new ();
  pixbuf = gdk_pixbuf_new_from_xpm_data (diagram_furrow);
  w->picture = (GtkPicture *) gtk_picture_new_for_pixbuf (pixbuf);
  gtk_grid_attach (w->box_picture, GTK_WIDGET (w->picture), 0, 0, 1, 1);
  w->label_models = (GtkLabel *) gtk_label_new
    (_("R: water retention capacity\n"
       "e=0: Gauckler-Manning's model\n"
       "e>0: Burguete's aerodynamical coefficient\n"
       "n(e=0): Gauckler-Manning's number\n"
       "n(e>0): Burguete's characteristic roughness length\n"
       "K: Kostiakov's constant\n"
       "a: Kostiakov's exponent\n"
       "f0: infiltration velocity in saturated soil"));
  gtk_grid_attach (w->box_picture, GTK_WIDGET (w->label_models), 1, 0, 1, 1);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->box_picture), 0, 0, 4, 1);
  w->label_furrow = (GtkLabel *) gtk_label_new
    (_("Number of irrigation furrows"));
  w->spin = (GtkSpinButton *) gtk_spin_button_new_with_range (0., 1000., 1.);
  w->button_recirculation = (GtkCheckButton *) gtk_check_button_new_with_label
    (_("Recirculation"));
  w->check_button_initial_conditions = (GtkCheckButton *)
    gtk_check_button_new_with_label (_("Initial conditions"));
  w->box_furrows = (GtkGrid *) gtk_grid_new ();
  gtk_grid_attach (w->box_furrows, GTK_WIDGET (w->label_furrow), 0, 0, 1, 1);
  gtk_grid_attach (w->box_furrows, GTK_WIDGET (w->spin), 1, 0, 1, 1);
  gtk_grid_attach (w->box_furrows, GTK_WIDGET (w->button_recirculation),
                   2, 0, 1, 1);
  gtk_grid_attach (w->box_furrows,
                   GTK_WIDGET (w->check_button_initial_conditions), 3, 0, 1, 1);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->box_furrows), 0, 1, 5, 1);
  w->button_furrow = (GtkButton *) gtk_button_new_with_label (_("Furrow"));
  gtk_widget_set_can_focus (GTK_WIDGET (w->button_furrow), FALSE);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->button_furrow), 2, 2, 3, 1);
  w->button_geometry = (GtkButton *) gtk_button_new_with_label (_("Geometry"));
  gtk_widget_set_can_focus (GTK_WIDGET (w->button_geometry), FALSE);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->button_geometry), 0, 4, 1, 4);
  w->button_soil = (GtkButton *) gtk_button_new_with_label (_("Soil"));
  gtk_widget_set_can_focus (GTK_WIDGET (w->button_soil), FALSE);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->button_soil), 0, 8, 1, 1);
  w->button_friction = (GtkButton *) gtk_button_new_with_label
    (_("Friction model"));
  gtk_widget_set_can_focus (GTK_WIDGET (w->button_friction), FALSE);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->button_friction), 0, 9, 1, 2);
  w->button_infiltration = (GtkButton *) gtk_button_new_with_label
    (_("Infiltration model"));
  gtk_widget_set_can_focus (GTK_WIDGET (w->button_infiltration), FALSE);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->button_infiltration), 0, 11, 1, 3);
  w->button_initial_conditions = (GtkButton *) gtk_button_new_with_label
    (_("Initial conditions"));
  gtk_widget_set_can_focus (GTK_WIDGET (w->button_initial_conditions), FALSE);
  gtk_grid_attach (w->grid, GTK_WIDGET (w->button_initial_conditions),
                   0, 14, 1, 3);
  for (i = 0; i < 13; ++i)
    {
      w->button_coefficient[i] =
        (GtkButton *) gtk_button_new_with_label (label_coefficient[i]);
      gtk_widget_set_can_focus (GTK_WIDGET (w->button_coefficient[i]), FALSE);
      gtk_grid_attach (w->grid, GTK_WIDGET (w->button_coefficient[i]),
                       1, 4 + i, 1, 1);
    }
  for (j = 0; j < 3; ++j)
    {
      gtk_grid_attach (w->grid, GTK_WIDGET (w->furrow[j].button),
                       2 + j, 3, 1, 1);
      for (i = 0; i < 13; ++i)
        gtk_grid_attach (w->grid, GTK_WIDGET (w->furrow[j].spin[i]),
                         j + 2, i + 4, 1, 1);
    }
  gtk_grid_attach (w->grid, gtk_label_new (NULL), 0, 7, 11, 1);
  g_signal_connect_swapped (w->spin, "changed",
                            (GCallback) table_config_furrows_update, w);
  g_signal_connect_swapped (w->button_recirculation, "toggled",
                            (GCallback) table_config_furrows_update, w);
  g_signal_connect_swapped (w->check_button_initial_conditions, "toggled",
                            (GCallback) table_config_furrows_update, w);
}
