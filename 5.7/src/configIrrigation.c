/*
SURCOS - A software tool to solve irrigation and fertigation in isolated furrows
and furrow networks.

Copyright 2011-2020, Javier Burguete Tolosa.

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
	list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice,
	this list of conditions and the following disclaimer in the documentation
	and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY Javier Burguete Tolosa ``AS IS'' AND ANY EXPRESS OR
IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL Javier Burguete Tolosa OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

/**
 * \file configIrrigation.c
 * \brief Source file to define the configuration of the irrigation.
 * \authors Javier Burguete Tolosa, Asier Lacasta Soto.
 * \copyright Copyright 2011-2020, Javier Burguete Tolosa.
 */
#include "config.h"
#include "jb/jb_win.h"
#include "configIrrigation.h"

#define DEBUG_INPUT_UPDATE 0
///< Macro to debug the config_irrigation_new() function

#define DEBUG_CONFIG_IRRIGATION_READ 0
///< Macro to debug the config_irrigation_read() function

#define DEBUG_CONFIG_IRRIGATION_NEW 0
///< Macro to debug the config_irrigation_new() function

extern char *input_dir;

///> Input diagram pixmap.
const char *diagram_input[] = {
/* columns rows colors chars-per-pixel */
  "283 160 2 1 ",
  "  c black",
  ". c white",
/* pixels */
  "...........................................................................................................................................................................................................................................................................................",
  "...........................................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  "....................  .....................................................................................................................................................................................................................................................................",
  "...................   .....................................................................................................................................................................................................................................................................",
  "...................   .....................................................................................................................................................................................................................................................................",
  "...................    ....................................................................................................................................................................................................................................................................",
  "..................   . ....................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  ".................... ......................................................................................................................................................................................................................................................................",
  "...........   ...... ......................................................................................................................................................................................................................................................................",
  ".......... .. ...... ......................................................................................................................................................................................................................................................................",
  "......... ... ...... ......................................................................................................................................................................................................................................................................",
  "......... .. ....... ......................................................................................................................................................................................................................................................................",
  "......... .. ....... .... ... .... ... ... .... ... .... ... .... ... ... .... ... .... .                                                                                                    ..............................................................................................",
  "..........   ....... .................................................................... .................................................................................................. ..............................................................................................",
  "............ ....... .................................................................... .................................................................................................. ..............................................................................................",
  "............ ....... .................................................................... .................................................................................................. ..............................................................................................",
  "..........   ....... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ..............................................................................................",
  ".................... .................................................................... .................................................................................................. ................................................................................. ............",
  ".................... .................................................................... .................................................................................................. ..................................................................................   .........",
  "....................                                                                                                                                                                                                                                                                 ......",
  "................................................................................................................................................................................................................................................................................    .......",
  "..............................................................................................................................................................................................................................................................................   ..........",
  "...........................................................................................................................................................................................................................................................................................",
  "..........  ................... ......................................................................................................................................................... .................................................................................................",
  ".......... ...   ........   .... ...................................................... ................................................................................................ ..................................................................................................",
  "......... ... ... ...... ... ... ..................................................... ................................................................................................. ..................................................................................................",
  "........ .... ... ...... ... .... .................................................... ...............................................................................................     ................................................................................................",
  "........ .... ... ...... ... .... ..................................................     ............................................................................................... ......  ..........................................................................................",
  "........ .... ... ...... ... .... .................................................... ................................................................................................. ......  ..........................................................................................",
  "........ .... ... ...... ... .... .................................................... ...   .......................................................................................... ...... ............................................................................................",
  "........ .... ... ...... ... .... ................................................... ... ... ......................................................................................... . ....  ...........................................................................................",
  "........ ....  .  ......  .  .... ................................................... . . ... .........................................................................................  ..... ............................................................................................",
  "........ .....   ... ....   ..... ...................................................  .. ... ................................................................................................ ............................................................................................",
  "......... .......... ........... ........................................................ ... ................................................................................................ ............................................................................................",
  "......... .......... ........... .........................................................   ................................................................................................ .............................................................................................",
  ".......... ......... .......... ............................................................................................................................................................  .............................................................................................",
  "...........................................................................................................................................................................................................................................................................................",
  "...........................................................................................................................................................................................................................................................................................",
  "...........................................................................................................................................................................................................................................................................................",
  "..........................................................................................................................................................................................................................................................................................."
};

/**
 * Function to insert inputs.
 */
static void
input_insert (GList ** list,    ///< List of inputs.
              unsigned int nInputsOld,  ///< Old inputs number.
              unsigned int nInputs,     ///< New inputs number.
              GtkGrid * table)  ///< configuration GtkGrid.
{
  double min[5] = { -1e6, -1e6, 0., 0., 0. };
  double max[5] = { 1e6, 1e6, 1e6, 1e6, 1. };
  double step[5] = { 0.01, 0.01, 1., 1., 1e-6 };
  char buffer[32];
  GtkWidget *widget;
  unsigned int i, j;
  for (i = nInputsOld; i < nInputs; ++i)
    {
      snprintf (buffer, 32, "%d", i + 1);
      widget = gtk_button_new_with_label (buffer);
      gtk_widget_set_can_focus (widget, FALSE);
      gtk_widget_show (widget);
      gtk_grid_attach (table, widget, 0, i + 1, 1, 1);
      *list = g_list_append (*list, widget);
      for (j = 0; j < 5; ++j)
        {
          widget = gtk_spin_button_new_with_range (min[j], max[j], step[j]);
          gtk_widget_show (widget);
          gtk_grid_attach (table, widget, j + 1, i + 1, 1, 1);
          *list = g_list_append (*list, widget);
        }
    }
}

/**
 * Function to remove inputs.
 */
static void
input_remove (GList ** list,    ///< List of inputs.
              unsigned int nInputsOld,  ///< Old inputs number.
              unsigned int nInputs)     ///< New inputs number.
{
  GList *element, *next;
  unsigned int i, j;
  element = g_list_nth (*list, 6 * nInputs);
  for (i = nInputs; i < nInputsOld; ++i)
    {
      for (j = 0; j < 6; ++j)
        {
          next = element->next;
          gtk_widget_destroy (GTK_WIDGET (element->data));
          *list = g_list_remove_link (*list, element);
          element = next;
        }
    }
}

/**
 * Function to update the inputs number.
 */
static void
input_update (GList ** list,    ///< List of inputs.
              unsigned int *nInputs,    ///< New inputs number.
              GtkSpinButton * spin,
              ///< GtkSpinButton defining the inputs number.
              GtkGrid * table)  ///< configuration GtkGrid.
{
  unsigned int nInputsOld;
  nInputsOld = *nInputs;
#if DEBUG_INPUT_UPDATE
  printf ("input_update: start\n");
#endif
  *nInputs = gtk_spin_button_get_value_as_int (spin);
#if DEBUG_INPUT_UPDATE
  printf ("nInputs = %d\n", *nInputs);
  printf ("Inserting rows\n");
#endif
  input_insert (list, nInputsOld, *nInputs, table);
#if DEBUG_INPUT_UPDATE
  printf ("Removing extra rows\n");
#endif
  input_remove (list, nInputsOld, *nInputs);
#if DEBUG_INPUT_UPDATE
  printf ("input_update: end\n");
#endif
}

/**
 * Function to save in a file the irrigation configuration.
 */
void
config_irrigation_write (ConfigIrrigation * w)
///< Structure of irrigation configuration.
{
  char buffer[512];
  double x[5];
  unsigned int n[2];
  GList *list;
  FILE *f;
  unsigned int i, j, k;
  snprintf (buffer, 512, "%s/input.in", input_dir);
  f = g_fopen (buffer, "w");
  n[0] = gtk_spin_button_get_value_as_int (w->spin[0]);
  n[1] = gtk_spin_button_get_value_as_int (w->spin[1]);
  fprintf (f, "%d %d\n", n[0], n[1]);
  for (j = 0; j < 2; ++j)
    {
      list = w->list[j];
      for (i = 0; i < n[j]; ++i)
        {
          list = list->next;
          for (k = 0; k < 5; ++k)
            {
              x[k] = gtk_spin_button_get_value (GTK_SPIN_BUTTON (list->data));
              list = list->next;
            }
          fprintf (f, "%lg %lg %lg %lg %lg\n", x[0], x[1], x[2], x[3], x[4]);
        }
    }
  fclose (f);
}

/**
 * Function to read in a file the irrigation configuration.
 */
static void
config_irrigation_read (ConfigIrrigation * w)
///< Structure of irrigation configuration.
{
  char buffer[512];
  double x[5];
  GList *list;
  FILE *f;
  unsigned int i, j, k;
#if DEBUG_CONFIG_IRRIGATION_READ
  printf ("config_irrigation_read: start\n");
#endif
  snprintf (buffer, 512, "%s/input.in", input_dir);
#if DEBUG_CONFIG_IRRIGATION_READ
  printf ("file = %s\n", buffer);
#endif
  f = g_fopen (buffer, "r");
  if (!f)
    {
//              jbw_show_error(_("Unable to open the inputs file"));
#if DEBUG_CONFIG_IRRIGATION_READ
      printf ("config_irrigation_read: end\n");
#endif
    }
  fscanf (f, "%u%u", w->n, w->n + 1);
  for (j = 0; j < 2; ++j)
    {
#if DEBUG_CONFIG_IRRIGATION_READ
      printf ("j=%u n=%u\n", j, w->n[j]);
#endif
      gtk_spin_button_set_value (w->spin[j], w->n[j]);
#if DEBUG_CONFIG_IRRIGATION_READ
      printf ("inserting row\n");
#endif
      input_insert (&w->list[j], 0, w->n[j], w->table[j]);
      list = w->list[j];
      for (i = 0; i < w->n[j]; ++i)
        {
          list = list->next;
          fscanf (f, "%lg%lg%lg%lg%lg", x, x + 1, x + 2, x + 3, x + 4);
#if DEBUG_CONFIG_IRRIGATION_READ
          printf ("x0=%lg x1=%lg x2=%lg x3=%lg x4=%lg\n",
                  x[0], x[1], x[2], x[3], x[4]);
#endif
          for (k = 0; k < 5; ++k)
            {
              gtk_spin_button_set_value (GTK_SPIN_BUTTON (list->data), x[k]);
              list = list->next;
            }
        }
    }
  fclose (f);
#if DEBUG_CONFIG_IRRIGATION_READ
  printf ("config_irrigation_read: end\n");
#endif
}

/**
 * Function to update the irrigation configuration water inputs.
 */
static void
config_irrigation_water (ConfigIrrigation * w)
///< Structure of irrigation configuration.
{
  input_update (&w->list[0], &w->n[0], w->spin[0], w->table[0]);
}

/**
 * Function to update the irrigation configuration fertilizer inputs.
 */
static void
config_irrigation_fertilizer (ConfigIrrigation * w)
///< Structure of irrigation configuration.
{
  input_update (&w->list[1], &w->n[1], w->spin[1], w->table[1]);
}

/**
 * Function to open the irrigation configuration table.
 */
void
config_irrigation_new (ConfigIrrigation * w)
///< Structure of irrigation configuration.
{
  char buffer[512];
  const char *label1[] = {
    _("Input"),
    "x (m)",
    "y (m)",
    _("Initial time (s)"),
    _("Final time (s)"),
    _("Discharge (m/s)")
  };
  const char *label2[] = {
    _("Input"),
    "x (m)",
    "y (m)",
    _("Initial time (s)"),
    _("Final time (s)"),
    _("Discharge (kg/s)")
  };
  const char *label_number[2] = {
    _("Number of water inputs"),
    _("Number of fertilizer inputs")
  };
  const char *label_frame[2] = { _("Water"), _("Fertilizer") };
  const char **label_input[2] = { label1, label2 };
  double min[2] = { 1., 0. };
  double max[2] = { 10., 10. };
  double step[2] = { 1., 1. };
  unsigned int i, j;

#if DEBUG_CONFIG_IRRIGATION_NEW
  printf ("config_irrigation_new: start\n");
  printf ("creating the boxes\n");
#endif
  w->box = (GtkGrid *) gtk_grid_new ();

  w->box_image = (GtkGrid *) gtk_grid_new ();
  gtk_grid_attach (w->box, GTK_WIDGET (w->box_image), 0, 0, 1, 1);
  w->image = (GtkImage *)
    gtk_image_new_from_pixbuf (gdk_pixbuf_new_from_xpm_data (diagram_input));
  gtk_grid_attach (w->box_image, GTK_WIDGET (w->image), 0, 0, 1, 1);
  snprintf (buffer, 512, "q: %s\nt0: %s\ntf: %s", _("Discharge"),
            _("Initial time"), _("Final time"));
  w->label_image = (GtkLabel *) gtk_label_new (buffer);
  gtk_grid_attach (w->box_image, GTK_WIDGET (w->label_image), 0, 1, 1, 1);

  w->box_input = (GtkGrid *) gtk_grid_new ();
  gtk_grid_attach (w->box, GTK_WIDGET (w->box_input), 1, 0, 1, 1);
  w->box_number = (GtkGrid *) gtk_grid_new ();
  gtk_grid_attach (w->box_input, GTK_WIDGET (w->box_number), 0, 0, 1, 1);

#if DEBUG_CONFIG_IRRIGATION_NEW
  printf ("adding frames\n");
#endif
  for (i = 0; i < 2; ++i)
    {
      w->label[i] = (GtkLabel *) gtk_label_new (label_number[i]);
      gtk_grid_attach (w->box_number, GTK_WIDGET (w->label[i]), 2 * i, 0, 1, 1);
      w->spin[i] =
        (GtkSpinButton *) gtk_spin_button_new_with_range (min[i], max[i],
                                                          step[i]);
      gtk_grid_attach (w->box_number, GTK_WIDGET (w->spin[i]), 2 * i + 1, 0,
                       1, 1);
      w->frame[i] = (GtkFrame *) gtk_frame_new (label_frame[i]);
      gtk_grid_attach (w->box_input, GTK_WIDGET (w->frame[i]), 0, i + 1, 5, 1);
      w->table[i] = (GtkGrid *) gtk_grid_new ();
      gtk_container_add (GTK_CONTAINER (w->frame[i]), GTK_WIDGET (w->table[i]));
      for (j = 0; j < 6; ++j)
        {
          w->button[j][i] = (GtkButton *) gtk_button_new_with_label
            (label_input[i][j]);
          gtk_widget_set_can_focus (GTK_WIDGET (w->button[j][i]), FALSE);
          gtk_grid_attach (w->table[i], GTK_WIDGET (w->button[j][i]),
                           j, 0, 1, 1);
        }
      w->list[i] = NULL;
    }

#if DEBUG_CONFIG_IRRIGATION_NEW
  printf ("setting values\n");
#endif
  config_irrigation_read (w);
  g_signal_connect_swapped (w->spin[0], "value-changed",
                            (GCallback) config_irrigation_water, w);
  g_signal_connect_swapped (w->spin[1], "value-changed",
                            (GCallback) config_irrigation_fertilizer, w);

#if DEBUG_CONFIG_IRRIGATION_NEW
  printf ("config_irrigation_new: end\n");
#endif
}
